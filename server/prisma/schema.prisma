generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "sqlite"
  url      = env("DATABASE_URL")
}

model User {
  id           String   @id @default(cuid())
  email        String   @unique
  passwordHash String
  role         String   @default("OPERATOR")
  createdAt    DateTime @default(now())
  logs         Log[]
}

model Car {
  id           String        @id @default(cuid())
  brand        String
  model        String
  trim         String?
  year         Int?
  pricePerHour Float
  pricePerDay  Float?
  bodyStyle    String?
  transmission String?
  fuel         String?
  seats        Int?
  images       String?
  type         String?
  status       String        @default("AVAILABLE")
  createdAt    DateTime      @default(now())
  updatedAt    DateTime      @updatedAt
  params       CarParamValue[]
  reservations Reservation[]
}

model CarParamDef {
  id      String    @id @default(cuid())
  name    String    @unique
  type    String
  options String?
  unit    String?
  values  CarParamValue[]
}

model CarParamValue {
  id        String      @id @default(cuid())
  car       Car         @relation(fields: [carId], references: [id], onDelete: Cascade)
  carId     String
  param     CarParamDef @relation(fields: [paramId], references: [id], onDelete: Cascade)
  paramId   String
  valueText String?
  valueNum  Float?
  valueEnum String?
}

model Reservation {
  id         String             @id @default(cuid())
  seq        Int                @default(0)
  car        Car                @relation(fields: [carId], references: [id], onDelete: Cascade)
  carId      String
  from       DateTime
  to         DateTime
  pickPlace  String?
  dropPlace  String?
  driverName String?
  driverPhone String?
  driverEmail String?
  driverLicense String?
  driverBirth   DateTime?
  driverAddress String?
  invoiceType   String?
  invoiceName   String?
  invoiceNum    String?   // ЕИК или ЕГН
  invoiceEgn    String?   // ЕГН (ако е физическо лице)
  invoiceVat    String?   // ДДС № (ако е фирма)
  invoiceMol    String?   // МОЛ
  invoiceBank   String?   // Банка
  invoiceIban   String?   // IBAN
  invoiceBic    String?   // BIC
  invoiceAddr   String?
  invoiceEmail  String?
  status     String             @default("PENDING")
  total      Float? 
  createdAt  DateTime           @default(now())
  invoices   Invoice[]
}

model Invoice {
  id              String       @id @default(cuid())
  reservation     Reservation  @relation(fields: [reservationId], references: [id], onDelete: Cascade)
  reservationId   String
  type            String       // PROFORMA | INVOICE
  number          String?      @unique
  issueDate       DateTime     @default(now())
  dueDate         DateTime?
  currency        String       @default("EUR")
  paymentMethod   String?
  paymentTerms    String?
  status          String       @default("DRAFT") // DRAFT | ISSUED | PAID | CANCELLED
  notes           String?
  // Supplier snapshot (from CompanyInfo at time of issuing)
  supplierName    String
  supplierEik     String
  supplierVat     String?
  supplierAddr    String
  supplierMol     String?
  supplierEmail   String?
  supplierPhone   String?
  supplierBank    String?
  supplierIban    String?
  supplierBic     String?
  // Buyer data (from reservation / edited)
  buyerType       String?      // company | individual
  buyerName       String?
  buyerEik        String?
  buyerVat        String?
  buyerEgn        String?
  buyerMol        String?
  buyerAddr       String?
  buyerEmail      String?
  buyerBank       String?
  buyerIban       String?
  buyerBic        String?
  // Lines
  items           String?      // JSON: [{description, qty, unitPrice, vatRate, totalNet, totalVat, totalGross}]
  subtotal        Float?
  vatAmount       Float?
  total           Float?
  createdAt       DateTime     @default(now())
  updatedAt       DateTime     @updatedAt
}

model Log {
  id        String   @id @default(cuid())
  user      User?    @relation(fields: [userId], references: [id])
  userId    String?
  action    String
  meta      String?
  createdAt DateTime @default(now())
}

model Location {
  id        String   @id @default(cuid())
  label     String   @unique
  active    Boolean  @default(true)
  createdAt DateTime @default(now())
}

model CompanyInfo {
  id        String   @id @default(cuid())
  name      String
  eik       String   // ЕИК/БУЛСТАТ
  vat       String?  // ДДС № (ако има)
  address   String
  city      String
  country   String   @default("България")
  mol       String?  // МОЛ
  email     String?
  phone     String?
  bank      String?
  iban      String?
  bic       String?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}


